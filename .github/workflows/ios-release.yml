name: iOS Release

on:
  workflow_dispatch:
    inputs:
      track:
        description: 'Release track'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - release
  push:
    tags:
      - 'ios-v*'

jobs:
  release:
    name: iOS Release
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Get Flutter dependencies
        working-directory: frontend_flutter
        run: flutter pub get
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
      
      - name: Install fastlane
        working-directory: frontend_flutter/ios
        run: |
          sudo gem install fastlane
          bundle install || true
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Setup Match (Code Signing)
        working-directory: frontend_flutter/ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
        run: |
          # Sync certificates and provisioning profiles
          fastlane match_sync || fastlane match_init
      
      - name: Build and Upload to TestFlight/App Store
        working-directory: frontend_flutter/ios
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TRACK="${{ github.event.inputs.track }}"
          else
            TRACK="beta"
          fi
          fastlane $TRACK
      
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: frontend_flutter/ios/build/*.ipa
          retention-days: 7

